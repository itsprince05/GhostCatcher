# Ghost Catcher Bot - Mechanism & Features (A to Z)

## 1. Overview
This is a specialized Telegram Bot designed to "Catch" (Log and Download) self-destructing media (Timer images, videos, View Once) from a user's Telegram account. It acts as a "Userbot" bridge, logging into the user's account to monitor messages in real-time.

## 2. Architecture & Tech Stack
- **Language:** Python
- **Library:** Telethon (Interaction with Telegram MTProto API)
- **Frontend (User Interface):** Telegram Bot Chat (@BotName)
- **Backend (Server):** 
  - Manages multiple concurrent User Sessions.
  - File System storage for Sessions (`users/`) and temporary media downloads (`downloads/`).

## 3. User Interaction Flow (Frontend)

### A. Onboarding & Login
1.  **Start:** User sends `/start`.
    -   *Bot Reply:* Welcome message with "Join Our Channel" button.
2.  **Login Request:** User sends `/login`.
    -   *Bot Reply:* Requests Phone Number.
3.  **Phone Entry:** User sends Phone Number (e.g., `+91...`).
    -   *Server Action:* Initiates Telegram Auth request.
    -   *Bot Reply:* Requests OTP.
4.  **OTP Entry:** User sends OTP.
    -   *Server Action:* Validates OTP. Checks for 2FA.
    -   *Bot Reply (If 2FA):* Requests Password.
    -   *Bot Reply (If Success):* "Login Successful...".
5.  **Post-Login Automations:**
    -   **Images:** Sends `itsme.jpg` and `time.jpg` with setup instructions.
    -   **Auto-Join:** Frequently joins the user to `@Ghost_Catcher_Robot` channel automatically.
    -   **Session Save:** Creates a persistent session file in `users/{UserID}/session.session`.

### B. Core Features (User Actions)

#### 1. Auto-Logging (The "Ghost Catching")
-   **Mechanism:** The bot runs a background client for the user (`UserSession`). It listens to *All Incoming Messages* on the user's account.
-   **Detection:** Checks if a message has `ttl_seconds`, `ttl_period`, or `expire_date` (Self-Destruct attributes).
-   **Action:**
    1.  Downloads the media to server.
    2.  **Log Group:** Forwards it to a private Admin Log Group with **Rich Details** (Sender ID, Name, Username, Receiver ID, etc.).
        -   *Target:* Separate groups for Normal Media vs Timer Media.
    3.  **User DM:** Sends a copy to the User's Bot Chat with **Simple Format** (Caption + Name).
    4.  **Cleanup:** Deletes the file from server immediately after sending.

#### 2. Manual Fetch (`/fetch`)
-   **User Action:** Sends `/fetch`.
-   **Bot Reply:** Shows a list of recent chats (Dialogs) as Buttons.
-   **User Action:** Clicks a Chat -> Enters User ID -> Bot Scans.
-   **Server Action:** Scans last 100 messages of that chat for media.
-   **Bot Reply:** Sends found media to user with **Simple Format** (`[1/2] Caption -- Name`).

#### 3. General Commands
-   `/id`: Displays User ID and Chat ID.
-   `/logout`: Disconnects session and deletes data.

## 4. Admin / Management Features (Backend)
Restricted to the **Update Group** (Admin Control Room).

-   **New User Alert:** When a new user starts the bot, a log is sent to Update Group (`New User: Name, ID, Username`).
-   `/list`: Generates and sends a text file (`all_users.txt`) with all registered User IDs.
-   `/stats`: Displays Total Users count and Active Sessions count.
-   `/broadcast`: Replies to a message to send it to ALL users. Shows Success/Fail stats.
-   `/ping`: Checks bot latency (e.g., `Ping - 45.20 ms`).
-   `/logs`: Sends the `crash.txt` file if a crash occurred.
-   `/restart`: Restarts the bot process (Updates code if `/update` used, or just reloads).
-   `/update`: Pulls latest code from Git and restarts.

## 5. Message Formats (Reply Styles)

### A. Manual Scan & User DM (Simplified)
Designed for clean user experience.
```
[Original Caption]
----------------------------------------
[Sender Name]
```

### B. Admin Log Group (Detailed)
Designed for forensic logging.
```
[Original Caption]
----------------------------------------
Sender - [ID]
[Name]
[Username]

Receiver - [ID]
[Name]
```

## 6. Server-Side Logic (Code Structure)

-   **`bot.py`**: The Main Orchestrator.
    -   Runs the Bot Client.
    -   Handles `/start`, `/login`, `/fetch` interactions.
    -   Manages the Login State Machine (Phone -> OTP -> 2FA).
    -   Handles Admin Commands (`/broadcast`, `/stats`, etc.).
    -   Restores sessions on startup (`restore_sessions`).

-   **`user_handler.py`**: The Worker.
    -   Defines `UserSession` class.
    -   Manages individual user client (Telethon).
    -   `on_new_message`: The event loop that detects Timer media.
    -   `scan_chat_and_download`: The logic for `/fetch`.
    -   `join_channel`: Auto-join logic.

-   **`config.py`**: Configuration.
    -   API Keys, Group IDs, Directory paths.

-   **`restart.txt`**: Temporary flag to confirm "Bot is active" after a restart.

---
*Generated by Gravity AI*
